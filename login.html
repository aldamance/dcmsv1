<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DENR-CENRO Diffun â€” Admin Panel</title>
  <link rel="icon" href="assets/denrlogo.png" type="image/svg+xml" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root{
      --green-900:#08331a;
      --green-700:#0b6137;
      --muted:#6b7280;
      --bg:#f7f9fb;
      --card:#ffffff;
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f7fbf7 0%, #f7f9fb 100%);color:#0f172a}

    .app{display:flex;min-height:100vh}
    .sidebar{
      width:280px;
      background:var(--green-900);
      color:white;
      padding:20px 16px;
      display:flex;
      flex-direction:column;
      gap:20px;
      position: sticky; top: 0; height: 100vh;
      z-index: 1000;
      box-shadow:0 6px 18px rgba(3,10,7,0.15);
    }
    
    .brand{display:flex; gap:12px; align-items:center; min-height: 44px;}
    .logo{width:44px;height:44px;border-radius:8px;}
    .brand h1{font-size:15px;margin:0}
    .brand p{margin:0;font-size:11px;opacity:.92}

    nav{display:flex;flex-direction:column;gap:8px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer;transition:background .18s;user-select:none}
    .nav-item:hover{background:rgba(255,255,255,0.06);}
    .nav-item.active{background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03))}

    .content{flex:1;padding:28px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(16,24,40,0.06); padding: 20px; margin-top: 20px;}
    
    /* Form Styles */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
    .form-group input, .form-group select { 
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; 
    }
    
    button.primary { background: var(--green-700); color: white; border: 0; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: var(--muted); }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    
    .role-badge { 
        padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; text-transform: uppercase;
    }
    .badge-admin { background: #fee2e2; color: #b91c1c; }
    .badge-viewer { background: #dcfce7; color: #15803d; }
    .badge-kiosk { background: #fef9c3; color: #a16207; }

  </style>
</head>
<body>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="assets/denrlogo.png" alt="Logo" class="logo">
        <div>
          <h1>DENR-CENRO Diffun</h1>
          <p>Admin Control Panel</p>
        </div>
      </div>

      <nav>
        <div class="nav-item" id="nav-dashboard">
          <i class="fas fa-chart-line"></i> <div>Dashboard</div>
        </div>
        <div class="nav-item active" id="nav-users">
          <i class="fas fa-users-cog"></i> <div>User Management</div>
        </div>
        <a href="index.html" class="nav-item" style="text-decoration:none; color:inherit;">
          <i class="fas fa-sign-out-alt"></i> <div>Logout</div>
        </a>
      </nav>
    </aside>

    <main class="content">
      <div class="title" style="font-size: 24px; font-weight: 700;">User Management</div>
      <p class="subtitle" style="color: var(--muted);">Create and manage system accounts</p>

      <section class="card">
        <h3>Create New Account</h3>
        <form id="createUserForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label>Username</label>
              <input type="text" id="username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" id="password" placeholder="Set password" required>
            </div>
            <div class="form-group">
              <label>Role</label>
              <select id="role">
                <option value="admin">Admin</option>
                <option value="viewer">Viewer</option>
                <option value="kiosk">Kiosk</option>
              </select>
            </div>
          </div>
          <button type="submit" class="primary">Create Account</button>
        </form>
      </section>

      <section class="card">
        <h3>Existing Accounts</h3>
        <div id="userListContainer">
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Created Date</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr><td colspan="3" style="text-align:center;">Loading users...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzIYJtKlvUvao1wiClGQuKGOI_UCQajw7dPK8T_w5m8BjkBbTzQY-6sovW4jacArjxlOQ/exec';

    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const payload = {
            action: 'create_user',
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            role: document.getElementById('role').value
        };

        Swal.fire({ title: 'Processing...', didOpen: () => Swal.showLoading() });

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.status === 'success') {
                Swal.fire('Success!', 'New account created.', 'success');
                document.getElementById('createUserForm').reset();
                loadUsers(); // Refresh the list
            } else {
                Swal.fire('Error', result.message, 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Could not connect to the database.', 'error');
        }
    });

async function loadUsers() {
    const tableBody = document.getElementById('userTableBody');
    try {
        console.log("Fetching from:", GAS_URL + '?action=list_users'); // Debug line
        const res = await fetch(GAS_URL + '?action=list_users');
        
        if (!res.ok) throw new Error('Network response was not ok');
        
        const users = await res.json();
        console.log("Users received:", users); // Debug line
        
        if (users.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No users found.</td></tr>';
            return;
        }

        tableBody.innerHTML = users.map(user => `
            <tr>
                <td><strong>${user.username}</strong></td>
                <td><span class="role-badge badge-${user.role}">${user.role}</span></td>
                <td>${user.dateCreated || 'N/A'}</td>
                <td>
                    <button onclick="deleteUser('${user.username}')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (e) {
        console.error("Fetch Error:", e); // This tells you EXACTLY what went wrong
        tableBody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error: ${e.message}</td></tr>`;
    }
}

async function deleteUser(username) {
    const confirm = await Swal.fire({
        title: 'Are you sure?',
        text: `Delete account for ${username}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
    });

    if (confirm.isConfirmed) {
        Swal.fire({ title: 'Deleting...', didOpen: () => Swal.showLoading() });
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'delete_user', username: username })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                Swal.fire('Deleted!', 'User has been removed.', 'success');
                loadUsers(); // Refresh table
            }
        } catch (err) {
            Swal.fire('Error', 'Could not delete user.', 'error');
        }
    }
}

    // Load list on startup
    window.onload = loadUsers;
  </script>
</body>
</html>